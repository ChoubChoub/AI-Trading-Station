# Low-Latency Trading Network & Kernel Optimization
# Consolidated sysctl settings for HFT/Trading workloads on modern Linux
# Last updated: 2025-09-05
# See /etc/sysctl.d/99-solarflare-trading.conf for details
# For rationale, see README at /etc/sysctl.d/99-solarflare-trading.README

# --- Socket Buffer Sizes (high throughput, burst tolerance) ---
net.core.rmem_max = 268435456
net.core.wmem_max = 268435456
net.core.rmem_default = 262144
net.core.wmem_default = 262144

# --- TCP buffer auto-tuning (large for trading bursts) ---
net.ipv4.tcp_rmem = 4096 262144 268435456
net.ipv4.tcp_wmem = 4096 262144 268435456

# --- Network Device Queue and Polling ---
net.core.netdev_max_backlog = 10000
net.core.netdev_budget = 600
net.core.netdev_budget_usecs = 5000
net.core.netdev_tstamp_prequeue = 0   # Disable timestamping overhead

# --- Busy Polling (reduces interrupt latency, increases CPU use) ---
net.core.busy_read = 50
net.core.busy_poll = 50

# --- TCP Feature Tuning ---
net.ipv4.tcp_timestamps = 0         # Lower latency, disables PAWS
net.ipv4.tcp_window_scaling = 1     # Allow >64KB windows (keep enabled)
net.ipv4.tcp_sack = 1               # Enable selective ACKs (recommended)
net.ipv4.tcp_fack = 1               # Enable FACK (recommended)
net.ipv4.tcp_congestion_control = bbr # Modern, low-latency congestion control

# --- TCP Misc Tuning ---
net.ipv4.tcp_low_latency = 1
net.ipv4.tcp_adv_win_scale = 1
net.ipv4.tcp_no_metrics_save = 1
net.ipv4.tcp_fin_timeout = 10
net.ipv4.tcp_tw_reuse = 1

# --- UDP Buffer Minimums (prevent packet drop on burst) ---
net.ipv4.udp_rmem_min = 8192
net.ipv4.udp_wmem_min = 8192

# --- System Memory & Socket ---
vm.swappiness = 1

# --- Redis HFT Connection Queue Optimization ---
net.core.somaxconn = 65535
net.ipv4.tcp_max_syn_backlog = 65535
vm.overcommit_memory = 1
